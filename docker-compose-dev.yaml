# Local / pre-push testing: all services in one compose, no Traefik.
# Usage: docker compose -f docker-compose-dev.yaml up -d
#
# Access:
#   Frontend:  http://localhost:3080
#   Ghost CMS: http://localhost:3080/cms  (via Nginx proxy)
#   Ghost API: http://localhost:2368/cms  (direct, for debugging)

services:
  mysql:
    image: mysql:8.0
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE:-ghost}
      MYSQL_USER: ${MYSQL_USER:-ghost}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - backend

  ghost:
    image: ghost:5-alpine
    restart: unless-stopped
    depends_on:
      mysql:
        condition: service_healthy
    environment:
      url: http://localhost:3080/cms
      database__client: mysql2
      database__connection__host: mysql
      database__connection__port: 3306
      database__connection__user: ${MYSQL_USER:-ghost}
      database__connection__password: ${MYSQL_PASSWORD}
      database__connection__database: ${MYSQL_DATABASE:-ghost}
      mail__transport: Direct
    volumes:
      - ghost-content:/var/lib/ghost/content
    ports:
      - "2368:2368"
    healthcheck:
      test: ["CMD", "wget", "-q", "-O", "/dev/null", "http://localhost:2368/cms/"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 60s
    networks:
      - backend

  frontend:
    build:
      context: frontend
      dockerfile: Dockerfile
      args:
        GHOST_URL: http://ghost:2368
        GHOST_CONTENT_API_KEY: ${GHOST_CONTENT_API_KEY}
    restart: unless-stopped
    depends_on:
      ghost:
        condition: service_healthy
    ports:
      - "3080:80"
    networks:
      - backend

volumes:
  mysql-data:
  ghost-content:

networks:
  backend:
    driver: bridge
